<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lernumgebung: Prüfungsangst – Strategien finden</title>
  <style>
    :root{
      --bg: #0b0f14;
      --card: rgba(18, 24, 33, .78);
      --card2: rgba(18, 24, 33, .62);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --line: rgba(255,255,255,.14);
      --accent: #8bd3ff;
      --accent2: #b7ffb3;
      --warn: #ffd37a;
      --bad: #ff8b8b;
      --good: #a7ffb0;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background: var(--bg);
      overflow-x:hidden;
    }

    /* ======= Atmosphärisches Hintergrundbild (Blur + Lesbarkeit) ======= */
    /*
      ÄNDERUNG EXPLIZIT MARKIERT (2026-01-06):
      - Hintergrundbild soll klar sichtbar/emotional präsent sein, aber weiterhin mit gutem Blur.
      - Anpassungen:
        1) Blur reduziert (12px -> 7px) damit Motiv erkennbar bleibt.
        2) Kontrast/Sättigung leicht erhöht für Präsenz.
        3) Overlay deutlich entschärft (weniger Abdunkelung, keine "Bild-erschlagenden" Radials).
        4) Zusätzlich eine weiche Vignette (transparent -> dunkel) für Lesbarkeit, ohne Bild zu killen.
    */
    .bg{
      position: fixed;
      inset: 0;
      z-index: -3;
      background-image: url("assets/pruefungsangst.jpg");
      background-size: cover;
      background-position: center;
      transform: scale(1.06);
      filter: blur(7px) saturate(1.18) contrast(1.08);
      opacity: 1;
    }

    /* ÄNDERUNG EXPLIZIT MARKIERT (2026-01-06): Overlay entschärft */
    .bgOverlay{
      position: fixed;
      inset: 0;
      z-index: -2;
      background:
        /* leichte Vignette für Lesbarkeit, Bild bleibt sichtbar */
        radial-gradient(1200px 700px at 50% 30%, rgba(0,0,0,.18), rgba(0,0,0,.55)),
        /* milde Abdunkelung nach unten */
        linear-gradient(to bottom, rgba(0,0,0,.22), rgba(0,0,0,.62));
    }

    .grain{
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events:none;
      opacity:.10;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(14px);
      background: rgba(0,0,0,.34);
      border-bottom: 1px solid var(--line);
    }
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 18px 40px;
    }

    .topRow{
      display:flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      gap: 12px;
      align-items:center;
      min-width: 280px;
    }
    .dot{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, var(--accent2), var(--accent));
      box-shadow: 0 0 22px rgba(139,211,255,.55);
    }
    h1{
      font-size: 18px;
      margin: 0;
      letter-spacing: .2px;
    }
    .subtitle{
      font-size: 12.8px;
      color: var(--muted);
      margin-top: 2px;
    }

    nav{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .tabBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .tabBtn:hover{ transform: translateY(-1px); border-color: rgba(139,211,255,.42); }
    .tabBtn.active{
      background: rgba(139,211,255,.16);
      border-color: rgba(139,211,255,.55);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }

    .row{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      margin-top: 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .row{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .cardHeader{
      padding: 16px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.00));
    }
    .cardHeader h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .cardHeader p{
      margin:8px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .cardBody{ padding: 16px; }
    .mini{ font-size: 12.5px; color: var(--muted); }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12.5px;
      margin: 6px 6px 0 0;
    }
    .pill strong{ color: var(--text); font-weight: 650; }

    .btnRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(139,211,255,.40); }
    .btn.primary{
      background: rgba(139,211,255,.18);
      border-color: rgba(139,211,255,.55);
    }
    .btn.good{
      background: rgba(167,255,176,.15);
      border-color: rgba(167,255,176,.45);
    }
    .btn.bad{
      background: rgba(255,139,139,.14);
      border-color: rgba(255,139,139,.40);
    }
    .btn.warn{
      background: rgba(255,211,122,.14);
      border-color: rgba(255,211,122,.42);
    }

    .progressWrap{
      margin-top: 12px;
      padding: 12px 16px 16px;
    }
    .progressBar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .progressFill{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(139,211,255,.85), rgba(167,255,176,.85));
      transition: width .25s ease;
    }
    .progressMeta{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      color: var(--muted);
      font-size: 12.5px;
      margin-top: 10px;
    }

    .section{
      display:none;
    }
    .section.active{
      display:block;
      animation: fadeIn .18s ease;
    }
    @keyframes fadeIn{
      from{ opacity: .0; transform: translateY(4px); }
      to{ opacity: 1; transform: translateY(0); }
    }

    .videoGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .videoCard{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      overflow:hidden;
    }
    .videoHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .videoTitle{
      font-size: 14px;
      margin:0;
    }
    .videoMeta{
      font-size: 12.5px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }
    .videoBody{
      padding: 12px;
    }
    video{
      width: 100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
    }
    .link{
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px dashed rgba(139,211,255,.45);
    }
    .link:hover{ border-bottom-style: solid; }

    .qWrap{
      display:flex;
      flex-direction: column;
      gap: 14px;
    }
    .qCard{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px;
    }
    .qTop{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .qBadge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
    }
    .qPrompt{
      margin: 10px 0 0;
      font-size: 14px;
      line-height:1.45;
    }
    .qPrompt strong{ color: #fff; }
    .options{
      margin-top: 12px;
      display:grid;
      gap: 10px;
    }
    .opt{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
    }
    .opt:hover{ border-color: rgba(139,211,255,.40); }
    .opt input{ margin-top: 2px; }
    .textAnswer{
      width: 100%;
      min-height: 78px;
      resize: vertical;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 14px;
      line-height:1.35;
      outline:none;
    }
    .textAnswer:focus{ border-color: rgba(139,211,255,.55); box-shadow: 0 0 0 3px rgba(139,211,255,.12); }

    .feedback{
      margin-top: 12px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      line-height: 1.4;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .feedback.good{ border-color: rgba(167,255,176,.45); background: rgba(167,255,176,.08); color: rgba(235,255,240,.95); }
    .feedback.bad{ border-color: rgba(255,139,139,.45); background: rgba(255,139,139,.07); color: rgba(255,240,240,.95); }
    .feedback.warn{ border-color: rgba(255,211,122,.45); background: rgba(255,211,122,.07); color: rgba(255,250,235,.95); }

    .toolbox{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px;
      line-height: 1.5;
    }
    .toolbox h3{ margin:0 0 8px; font-size: 14px; }
    .toolbox ul{ margin: 8px 0 0; padding-left: 18px; color: var(--muted); }
    .toolbox li{ margin: 6px 0; }

    .kpi{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .kpiBox{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,.05);
    }
    .kpiNum{ font-size: 20px; font-weight: 800; }
    .kpiLab{ font-size: 12.5px; color: var(--muted); margin-top: 4px; }

    .hr{
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    .docList{
      display:grid;
      gap: 10px;
      margin-top: 12px;
    }
    .docItem{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .docItem strong{ display:block; font-size: 13.5px; }
    .docItem span{ display:block; font-size: 12.5px; color: var(--muted); margin-top: 4px; max-width: 760px; }

    .embedPdf{
      width: 100%;
      height: 520px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
    }

    footer{
      margin-top: 22px;
      color: rgba(255,255,255,.62);
      font-size: 12.5px;
      line-height: 1.45;
    }
    .smallNote{
      color: rgba(255,255,255,.66);
      font-size: 12.5px;
      line-height: 1.45;
    }

    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 50;
      max-width: 420px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      display:none;
      white-space: pre-wrap;
      color: rgba(255,255,255,.90);
      font-size: 13px;
      line-height: 1.35;
    }

    /* Accessibility */
    .srOnly{
      position:absolute;
      left:-9999px;
      width:1px; height:1px;
      overflow:hidden;
    }
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="bgOverlay" aria-hidden="true"></div>
  <div class="grain" aria-hidden="true"></div>

  <header>
    <div class="wrap">
      <div class="topRow">
        <div class="brand">
          <div class="dot" aria-hidden="true"></div>
          <div>
            <h1>Prüfungsangst – Lernraum für Strategien</h1>
            <div class="subtitle">Ziel: deine Muster verstehen · dein Werkzeugkoffer wachsen lassen · deinen Plan bauen</div>
          </div>
        </div>

        <nav aria-label="Navigation">
          <button class="tabBtn active" data-tab="start">Start</button>
          <button class="tabBtn" data-tab="videos">Filme</button>
          <button class="tabBtn" data-tab="wissen">Wissen & Materialien</button>
          <button class="tabBtn" data-tab="quiz">15 Inhaltsfragen</button>
          <button class="tabBtn" data-tab="reflexion">15 Selbsterfahrungsaufgaben</button>
          <button class="tabBtn" data-tab="plan">Mein Plan</button>
        </nav>
      </div>

      <div class="progressWrap">
        <div class="progressBar" aria-label="Fortschritt">
          <div class="progressFill" id="progressFill"></div>
        </div>
        <div class="progressMeta">
          <div id="progressText">Fortschritt: 0%</div>
          <div id="progressDetail">Quiz: 0/15 · Selbsterfahrung: 0/15 · Strategien gespeichert: 0</div>
        </div>

        <div class="btnRow" style="margin-top:12px;">
          <!-- ÄNDERUNG EXPLIZIT MARKIERT: Reset-Button (löscht lokal gespeicherte Antworten/Status) -->
          <button class="btn warn" id="resetBtn" title="Löscht deinen lokalen Fortschritt auf diesem Gerät">Reset</button>
          <button class="btn" id="exportBtn" title="Exportiert deinen Plan als Textdatei">Plan exportieren</button>
          <button class="btn good" id="quickSaveBtn" title="Speichert deinen Status (automatisch, aber hier als bewusster Klick)">Jetzt speichern</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- ======= START ======= -->
    <section class="section active" id="tab-start">
      <div class="row">
        <div class="card">
          <div class="cardHeader">
            <h2>Worum es hier geht</h2>
            <p>
              Prüfungsangst ist nicht nur „Nervosität“. Sie kann Denken blockieren, den Körper alarmieren
              und Verhalten verändern (z. B. Vermeidung, Überlernen, Perfektionismus, Blackout).
              In diesem Lernraum baust du <strong>Wissen + Selbsterkenntnis + konkrete Strategien</strong> zusammen.
            </p>
          </div>
          <div class="cardBody">
            <div class="pill"><strong>1</strong> Filme ansehen & Notizen sammeln</div>
            <div class="pill"><strong>2</strong> 15 Inhaltsfragen (Sofortkorrektur)</div>
            <div class="pill"><strong>3</strong> 15 Selbsterfahrungsaufgaben (Chatbot-Kommentar)</div>
            <div class="pill"><strong>4</strong> „Mein Plan“: persönliche Strategien bündeln</div>

            <div class="hr"></div>

            <div class="toolbox">
              <h3>Arbeitsregel (ehrlich & hilfreich)</h3>
              <ul>
                <li>Du darfst Angst haben. Ziel ist nicht „cool sein“, sondern <strong>handlungsfähig bleiben</strong>.</li>
                <li>Wir suchen <strong>deine</strong> Muster: Körper · Gedanken · Gefühle · Verhalten · Umfeld.</li>
                <li>Strategien sind Werkzeuge. Ein Werkzeug ist nicht „gut“, wenn es dich beruhigt – sondern wenn es dich <strong>weiterbringen</strong> kann.</li>
              </ul>
            </div>

            <div class="hr"></div>

            <div class="btnRow">
              <button class="btn primary" data-jump="videos">Direkt zu den Filmen</button>
              <button class="btn primary" data-jump="quiz">Direkt zu den Inhaltsfragen</button>
              <button class="btn primary" data-jump="reflexion">Direkt zu den Selbsterfahrungsaufgaben</button>
            </div>

            <div class="hr"></div>
            <div class="smallNote">
              Hinweis: Dieser Lernraum ersetzt keine Therapie. Wenn Angst dich dauerhaft massiv einschränkt
              (Schulvermeidung, Panik, Schlafverlust, Selbstwert im Keller), hol dir Unterstützung
              (Vertrauensperson, Schulsozialarbeit, Hausarzt, Psycholog*in).
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>Dein Status</h2>
            <p>Damit du merkst, dass du vorankommst – ohne Druck-Show.</p>
          </div>
          <div class="cardBody">
            <div class="kpi">
              <div class="kpiBox">
                <div class="kpiNum" id="kpiQuiz">0/15</div>
                <div class="kpiLab">Inhaltsfragen abgeschlossen</div>
              </div>
              <div class="kpiBox">
                <div class="kpiNum" id="kpiRef">0/15</div>
                <div class="kpiLab">Selbsterfahrungsaufgaben bearbeitet</div>
              </div>
              <div class="kpiBox">
                <div class="kpiNum" id="kpiTools">0</div>
                <div class="kpiLab">Strategien gespeichert</div>
              </div>
              <div class="kpiBox">
                <div class="kpiNum" id="kpiMood">–</div>
                <div class="kpiLab">dein aktuelles Stress-Level</div>
              </div>
            </div>

            <div class="hr"></div>

            <label for="mood" class="mini">Kurzer Check-in (0–10): Wie stark ist Prüfungsstress gerade?</label>
            <input id="mood" type="range" min="0" max="10" step="1" value="0" style="width:100%; margin-top:8px;">
            <div class="mini" id="moodText" style="margin-top:8px;">0/10</div>

            <div class="hr"></div>

            <div class="toolbox">
              <h3>Mini-Notfall (30–90 Sekunden)</h3>
              <ul>
                <li><strong>Atmen:</strong> 4 Sekunden ein · 6 Sekunden aus (6 Wiederholungen).</li>
                <li><strong>Orientieren:</strong> 5 Dinge sehen · 4 fühlen · 3 hören · 2 riechen · 1 schmecken.</li>
                <li><strong>Reframe:</strong> „Mein Körper macht Alarm – ich steuere ihn jetzt runter.“</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= VIDEOS ======= -->
    <section class="section" id="tab-videos">
      <div class="row">
        <div class="card">
          <div class="cardHeader">
            <h2>Filme (extern & eingebettet)</h2>
            <p>
              Tipp: Schau pro Film mit einer Frage-Brille:
              <strong>Was triggert?</strong> · <strong>Was hilft kurzfristig?</strong> · <strong>Was hilft langfristig?</strong>
            </p>
          </div>
          <div class="cardBody">
            <div class="videoGrid" id="videoGrid"></div>
            <div class="hr"></div>
            <div class="smallNote">
              Wenn ein eingebettetes Video nicht startet, nutze den „Extern öffnen“-Link (Dropbox blockiert Einbettung manchmal).
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>Arbeitsauftrag während der Filme</h2>
            <p>Du sammelst Rohmaterial, das du später in „Mein Plan“ verwandelst.</p>
          </div>
          <div class="cardBody">
            <div class="toolbox">
              <h3>Notizstruktur (abschreiben ist erlaubt)</h3>
              <ul>
                <li><strong>Trigger:</strong> Was macht Druck? (Zeit, Vergleich, Erwartungen, Bewertung…)</li>
                <li><strong>Körper:</strong> Was passiert bei dir? (Herz, Bauch, Hände, Atem…)</li>
                <li><strong>Gedanken:</strong> Welche Sätze tauchen auf?</li>
                <li><strong>Verhalten:</strong> Was tust du dann? (Vermeiden, Überlernen, Ablenken…)</li>
                <li><strong>Hilfe:</strong> Was wirkt sofort? Was wirkt über Wochen?</li>
              </ul>
            </div>

            <div class="hr"></div>

            <button class="btn primary" data-jump="quiz">Weiter zu den Inhaltsfragen</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= WISSEN & MATERIALIEN ======= -->
    <section class="section" id="tab-wissen">
      <div class="row">
        <div class="card">
          <div class="cardHeader">
            <h2>Materialien (PDFs)</h2>
            <p>
              Hier sind die Texte als Lernanker. Du musst nicht alles „auswendig“ lernen:
              Nutze sie als Werkzeugkasten (Erklärung + Beispiele + Handlungsoptionen).
            </p>
          </div>
          <div class="cardBody">
            <div class="docList" id="docList"></div>

            <div class="hr"></div>

            <div class="toolbox">
              <h3>Kernideen, die in den Materialien immer wieder auftauchen</h3>
              <ul>
                <li><strong>Stress ist nicht nur schlecht</strong> – entscheidend ist die Bewertung & Steuerung.</li>
                <li><strong>Angst kann sich aufschaukeln</strong> (Kreislauf/Schleife) und wird durch Vermeidung kurzfristig belohnt.</li>
                <li><strong>Realistische Ziele + gute Lernstrategien</strong> wirken langfristig.</li>
                <li><strong>Umfeldsatz:</strong> Druck/Erwartungen können Angst verstärken – Sicherheit/Vertrauen kann sie senken.</li>
              </ul>
            </div>

            <div class="hr"></div>

            <div class="smallNote">
              Optional: Wenn du möchtest, kann ich dir danach auch eine „Lehrer*innen-Ansicht“ mit PDF-Export
              (Fragen + Musterlösungen) bauen. (Hier noch nicht aktiviert, damit nichts unnötig „mehr“ wird.)
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>PDF-Vorschau</h2>
            <p>Wähle links ein PDF – es wird hier eingebettet angezeigt (falls Browser es erlaubt).</p>
          </div>
          <div class="cardBody">
            <iframe class="embedPdf" id="pdfFrame" title="PDF Vorschau"></iframe>
            <div class="hr"></div>
            <div class="smallNote">
              Wenn die Vorschau leer bleibt: PDF per Button „Öffnen“ in neuem Tab öffnen.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= QUIZ ======= -->
    <section class="section" id="tab-quiz">
      <div class="row">
        <div class="card">
          <div class="cardHeader">
            <h2>15 Inhaltsfragen – mit Sofortkorrektur</h2>
            <p>
              Regel: 1. Fehler = „falsch“ · 2. Fehler = Hinweis · 3. Fehler = Musterlösung + weiter.
              Bei richtig: „richtig“ + weiter.
            </p>
          </div>
          <div class="cardBody">
            <div class="qWrap" id="quizWrap"></div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>Warum diese Fragen?</h2>
            <p>Damit du nicht nur „weiss“, sondern verstehst: Mechanismus → Konsequenz → Gegenstrategie.</p>
          </div>
          <div class="cardBody">
            <div class="toolbox">
              <h3>Wenn du hängenbleibst</h3>
              <ul>
                <li>Suche im Film/Text: <strong>Auslöser</strong> vs. <strong>Aufrechterhalter</strong>.</li>
                <li>Frage dich: „Was wäre eine <strong>kleine</strong> Veränderung, die viel bewirkt?“</li>
                <li>Nutze Hinweise nicht als „Schummeln“, sondern als „Lern-Check“.</li>
              </ul>
            </div>
            <div class="hr"></div>
            <button class="btn primary" data-jump="reflexion">Weiter zu den Selbsterfahrungsaufgaben</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= REFLEXION ======= -->
    <section class="section" id="tab-reflexion">
      <div class="row">
        <div class="card">
          <div class="cardHeader">
            <h2>15 Selbsterfahrungsaufgaben – mit Chatbot-Kommentar</h2>
            <p>
              Schreibe ehrlich, auch unperfekt. Du bekommst eine individuelle Rückmeldung:
              klar, empathisch, ohne Anbiedern – und mit konkreten nächsten Schritten.
            </p>
          </div>
          <div class="cardBody">
            <div class="qWrap" id="refWrap"></div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>Dein Werkzeugkoffer (live)</h2>
            <p>Hier landen Strategien, die du aus den Aufgaben heraus auswählst.</p>
          </div>
          <div class="cardBody">
            <div class="toolbox" id="toolboxLive">
              <h3>Gespeicherte Strategien</h3>
              <div class="mini">Noch keine gespeichert.</div>
            </div>
            <div class="hr"></div>
            <button class="btn primary" data-jump="plan">Zu „Mein Plan“</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= PLAN ======= -->
    <section class="section" id="tab-plan">
      <div class="row">
        <div class="card">
          <div class="cardHeader">
            <h2>Mein Plan – meine Strategien gegen Prüfungsangst</h2>
            <p>
              Du baust 3 Ebenen: <strong>Vorbereitung</strong> · <strong>Prüfungsmoment</strong> · <strong>Nachbereitung</strong>.
              Ziel: handlungsfähig bleiben – nicht perfekt sein.
            </p>
          </div>
          <div class="cardBody">
            <div class="toolbox" id="planBox"></div>

            <div class="hr"></div>

            <div class="btnRow">
              <button class="btn good" id="buildPlanBtn">Plan aktualisieren</button>
              <button class="btn primary" id="copyPlanBtn">Plan kopieren</button>
              <button class="btn warn" id="clearPlanNotesBtn">Plan-Notizen löschen</button>
            </div>

            <div class="hr"></div>

            <label class="mini" for="planNotes"><strong>Meine konkreten Vereinbarungen</strong> (Termine, Routinen, Sätze, Mini-Übungen)</label>
            <textarea id="planNotes" class="textAnswer" placeholder="Beispiel: 3 Tage vor Prüfung: 45/10-Lernblöcke. Am Abend davor: Unterlagen um 19:00 zu. 10 Min Spaziergang. In der Prüfung: 2 Min Bauch-Atmen, Blatt umdrehen, dann Aufgaben scannen."></textarea>
            <div class="btnRow">
              <button class="btn good" id="savePlanNotesBtn">Notizen speichern</button>
            </div>

            <div class="hr"></div>

            <div class="smallNote">
              Wenn du merkst: „Ich vermeide Schule/Prüfungen konsequent“ oder „Panik dominiert“:
              dann ist das kein Charakterfehler – sondern ein Signal, dass du Unterstützung verdient hast.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>Kurzer Realitätscheck</h2>
            <p>Ein Plan ist nur gut, wenn er in der echten Welt funktioniert.</p>
          </div>
          <div class="cardBody">
            <div class="toolbox">
              <h3>3 Fragen</h3>
              <ul>
                <li>Ist mein Plan <strong>machbar</strong> an einem schlechten Tag?</li>
                <li>Welche Strategie ist mein <strong>Notfall-Anker</strong> (30–90 s)?</li>
                <li>Welche Strategie ist mein <strong>Wachstums-Hebel</strong> (über Wochen)?</li>
              </ul>
            </div>
            <div class="hr"></div>
            <button class="btn primary" data-jump="start">Zurück zum Start</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="wrap">
      <div>
        <strong>Datenschutz:</strong> Alles wird lokal in deinem Browser gespeichert (localStorage). Kein Upload, kein Tracking.
      </div>
      <div style="margin-top:6px;">
        <strong>Hinweis zu Filmen:</strong> Externe Links bleiben bei Dropbox. Einbettung kann je nach Browser/Dropbox-Einstellungen blockiert sein.
      </div>
    </footer>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    /**********************************************************************
     *  ÄNDERUNG EXPLIZIT MARKIERT:
     *  - Vollständige interaktive Lernumgebung mit:
     *    - Tabs / Navigation
     *    - 4 Filme (mit externen Links + Einbettungsversuch)
     *    - 15 Inhaltsfragen (Sofortkorrektur: falsch/hinweis/musterlösung)
     *    - 15 Selbsterfahrungsaufgaben (Chatbot-Kommentar + Strategien speichern)
     *    - Plan-Generator + Export + Reset + localStorage Persistenz
     **********************************************************************/

    const LS_KEY = "pruefungsangst_lernraum_v1";

    const state = loadState() || {
      tab: "start",
      mood: 0,
      quiz: {
        index: 0,
        attempts: {},      // qid -> number
        done: {},          // qid -> true
        answers: {}        // qid -> user answer snapshot
      },
      reflexion: {
        attempts: {},      // rid -> number (optional)
        done: {},          // rid -> true
        text: {},          // rid -> user text
        bot: {},           // rid -> bot reply
        strategies: []     // array of {id, title, level, when, how, why}
      },
      planNotes: ""
    };

    // ===== Toast =====
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.style.display = "none", 2600);
    }

    // ===== Helpers =====
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      updateAll();
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }
    function resetState(){
      localStorage.removeItem(LS_KEY);
      location.reload();
    }

    function byId(id){ return document.getElementById(id); }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function normalizeText(s){
      if(!s) return "";
      // Lowercase, trim, remove extra spaces, replace umlauts variants, strip punctuation
      const map = [
        ["ä","ae"],["ö","oe"],["ü","ue"],["ß","ss"]
      ];
      let t = String(s).toLowerCase().trim();
      for(const [a,b] of map) t = t.replaceAll(a,b);
      t = t
        .replace(/[“”„"']/g, "")
        .replace(/[\.\,\!\?\:\;\(\)\[\]\{\}]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
      return t;
    }

    function containsKeywords(text, keywords, minHits){
      const t = normalizeText(text);
      let hits = 0;
      for(const k of keywords){
        const kk = normalizeText(k);
        if(kk && t.includes(kk)) hits++;
      }
      return hits >= minHits;
    }

    function shuffleArray(arr){
      // Fisher–Yates
      const a = [...arr];
      for(let i=a.length-1; i>0; i--){
        const j = Math.floor(Math.random() * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // ===== Tabs =====
    const tabButtons = Array.from(document.querySelectorAll(".tabBtn"));
    tabButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const t = btn.dataset.tab;
        setTab(t);
      });
    });

    document.querySelectorAll("[data-jump]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setTab(btn.dataset.jump);
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });

    function setTab(tab){
      state.tab = tab;
      document.querySelectorAll(".section").forEach(sec=>sec.classList.remove("active"));
      byId("tab-"+tab).classList.add("active");

      tabButtons.forEach(b=> b.classList.toggle("active", b.dataset.tab === tab));
      saveState();
    }

    // ===== Mood slider =====
    const mood = byId("mood");
    const moodText = byId("moodText");
    mood.value = state.mood ?? 0;
    moodText.textContent = (state.mood ?? 0) + "/10";
    byId("kpiMood").textContent = (state.mood ?? 0) + "/10";

    mood.addEventListener("input", ()=>{
      state.mood = Number(mood.value);
      moodText.textContent = state.mood + "/10";
      byId("kpiMood").textContent = state.mood + "/10";
      saveState();
    });

    // ===== Buttons =====
    byId("resetBtn").addEventListener("click", ()=>{
      const ok = confirm("Reset wirklich ausführen? (Alle lokalen Antworten und Fortschritte werden gelöscht.)");
      if(ok) resetState();
    });

    byId("quickSaveBtn").addEventListener("click", ()=>{
      saveState();
      toast("Gespeichert.");
    });

    byId("exportBtn").addEventListener("click", ()=>{
      const txt = buildExportText();
      downloadText("Mein_Pruefungsangst_Plan.txt", txt);
      toast("Export gestartet.");
    });

    // ===== Videos =====
    const videos = [
      {
        id: "v1",
        title: "Robertos Prüfungsangst (Fallbeispiel)",
        note: "Beobachte: Trigger → Körper → Gedanken → Verhalten → was könnte helfen?",
        url: "https://www.dropbox.com/scl/fi/yykrmxdvubw283fwhsll3/Robertos-Pr-fungsangst.mp4?rlkey=fn358pa327e01eu1bgcui4cjw&st=5otruzyu&dl=0"
      },
      {
        id: "v2",
        title: "6-Semester-Lernfilmreihe zur Prüfungsangst (1. Semester – 1)",
        note: "Achte auf: Angstrückkopplung/Schleife, Prüfungsphase, Kurz- vs Langfriststrategien.",
        url: "https://www.dropbox.com/scl/fi/jc7rtal7s0ry1yfci65to/6-Semester-Lernfilmreihe-zur-Pr-fungsangst-1.SEMESTER-1.mp4?rlkey=s7rzosvk2griov7ci7fe1kt9q&st=cy4p02ha&dl=0"
      },
      {
        id: "v3",
        title: "Angst vor der Schule (ARTE Re:)",
        note: "Achte auf: Schulangst/Schulphobie, Systemdruck, Unterstützung, alternative Programme.",
        url: "https://www.dropbox.com/scl/fi/mu18j175l8htqk18ey02r/Angst-vor-der-Schule-ARTE-Re.mp4?rlkey=16m5parhldo2zbv50q5fiu8j2&st=8v3jvc1i&dl=0"
      },
      {
        id: "v4",
        title: "Was hilft gegen Schul- und Prüfungsangst? (SWR Wissen)",
        note: "Achte auf: Was wirkt im Akutfall? Was wirkt als Training? Rolle von Erwartungen & Umfeld.",
        url: "https://www.dropbox.com/scl/fi/l0y4frcmn8d8k451or1ap/Was-hilft-gegen-Schul-und-Pr-fungsangst-SWR-Wissen.mp4?rlkey=h10mgav1sj4a8ns3glkl6j4xr&st=5gan74c4&dl=0"
      }
    ];

    function dropboxDirectTry(url){
      // Versuch 1: dl=1
      const u1 = url.replace("&dl=0","&dl=1");
      // Versuch 2: raw=1 (manche Dropbox-Links)
      const u2 = url.replace("&dl=0","&raw=1");
      return {u1, u2};
    }

    function renderVideos(){
      const grid = byId("videoGrid");
      grid.innerHTML = "";

      videos.forEach(v=>{
        const {u1,u2} = dropboxDirectTry(v.url);
        const card = document.createElement("div");
        card.className = "videoCard";

        card.innerHTML = `
          <div class="videoHead">
            <div>
              <p class="videoTitle"><strong>${escapeHtml(v.title)}</strong></p>
              <div class="videoMeta">${escapeHtml(v.note)}</div>
            </div>
            <div class="btnRow" style="margin-top:0;">
              <a class="btn primary" href="${v.url}" target="_blank" rel="noopener">Extern öffnen</a>
            </div>
          </div>
          <div class="videoBody">
            <video controls preload="metadata">
              <source src="${u2}" type="video/mp4">
              <source src="${u1}" type="video/mp4">
              Dein Browser kann dieses Video nicht abspielen. Nutze „Extern öffnen“.
            </video>
            <div class="mini" style="margin-top:10px;">
              Falls das Video hier nicht startet: <a class="link" href="${v.url}" target="_blank" rel="noopener">Dropbox-Link öffnen</a>.
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // ===== Docs =====
    const docs = [
      {
        id: "d1",
        title: "Prüfungsangst bei Kindern – Was Eltern und Betroffenen hilft",
        desc: "Mechanismen (Blackout), Angstkreislauf, Druck rausnehmen, ernst nehmen, kleine Prüfungssituationen.",
        path: "docs/Pruefungsangst_bei_Kindern_Was_Eltern_und_Betroffenen_hilft.pdf"
      },
      {
        id: "d2",
        title: "Tipps von Lerncoach – Was hilft gegen Prüfungsangst?",
        desc: "Angsttypen, Zusammenhang mit Erwartungen/Perfektionismus, Lernstrategien & Verhaltensänderungen.",
        path: "docs/Tipps_von_Lerncoach_Was_hilft_gegen_Pruefungsangst.pdf"
      },
      {
        id: "d3",
        title: "Last-Minute-Tipps für die Gymiprüfung (Zürich)",
        desc: "Nervosität umdeuten, Zeitpunkt „genug gelernt“, Blackout-Notfall (Atmen, Blatt umdrehen), Druck reduzieren.",
        path: "docs/Aufnahme_Zuercher_Mittelschulen_Last_Minute_Tipps_Gymipruefung.pdf"
      },
      {
        id: "d4",
        title: "5 Punkte für eine Bildungsoffensive – Braucht die Schweiz mehr Gymnasiasten?",
        desc: "Systemdruck, Selektion, Stress, Diskussion um Matura-Quoten und Durchlässigkeit.",
        path: "docs/5_Punkte_Bildungsoffensive_Braucht_CH_mehr_Gymnasiasten.pdf"
      },
      {
        id: "d5",
        title: "Gymiprüfung – muss das sein?",
        desc: "Glaubenssätze, Reformdebatte, Selektion, Durchlässigkeit, Stressfaktoren.",
        path: "docs/Gymipruefung_muss_das_sein.pdf"
      }
    ];

    function renderDocs(){
      const list = byId("docList");
      list.innerHTML = "";
      docs.forEach(d=>{
        const item = document.createElement("div");
        item.className = "docItem";
        item.innerHTML = `
          <div>
            <strong>${escapeHtml(d.title)}</strong>
            <span>${escapeHtml(d.desc)}</span>
          </div>
          <div class="btnRow" style="margin-top:0;">
            <button class="btn" data-doc-open="${d.path}">Vorschau</button>
            <a class="btn primary" href="${d.path}" target="_blank" rel="noopener">Öffnen</a>
          </div>
        `;
        list.appendChild(item);
      });

      list.querySelectorAll("[data-doc-open]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const path = btn.getAttribute("data-doc-open");
          byId("pdfFrame").src = path;
          toast("PDF geladen (falls Browser die Vorschau erlaubt).");
        });
      });
    }

    // ===== Quiz data (15) =====
    const quiz = [
      {
        id: "q1",
        type: "mc",
        source: "Grundmechanismus",
        prompt: "Welche Aussage beschreibt Prüfungsangst am treffendsten?",
        options: [
          { id:"a", text:"Sie ist immer ein Zeichen von Faulheit.", correct:false },
          { id:"b", text:"Sie ist eine Stressreaktion, die Denken/Erinnern blockieren kann.", correct:true },
          { id:"c", text:"Sie betrifft nur schwache Schüler*innen.", correct:false },
          { id:"d", text:"Sie verschwindet automatisch, wenn man mehr Druck macht.", correct:false }
        ],
        hint: "Denk an Blackout/Blockade: Wissen ist da, Zugriff fehlt.",
        solution: "Prüfungsangst ist eine Stress-/Angstreaktion. Sie kann Konzentration und Abruf von Wissen stören oder blockieren."
      },
      {
        id: "q2",
        type: "text",
        source: "Angstkreislauf",
        prompt: "Erkläre in 2–4 Sätzen, warum Vermeidung die Prüfungsangst oft langfristig verstärkt.",
        check: (ans)=> containsKeywords(ans, ["sofortige entlastung","belohnung","kurzfristig","kreislauf","verstaerkt","vermeidung"], 3),
        hint: "Kurzfristige Erleichterung wirkt wie „Belohnung“ – und macht die nächste Situation bedrohlicher.",
        solution: "Vermeidung entlastet sofort (das fühlt sich wie eine Belohnung an). Dadurch wird nicht erlebt, dass man die Situation bewältigen kann. Die Angst bleibt unkorrigiert und kann sich beim nächsten Mal sogar stärker aufschaukeln."
      },
      {
        id: "q3",
        type: "mc",
        source: "Reframing von Körpersymptomen",
        prompt: "Welche Umdeutung kann Nervosität eher entschärfen?",
        options: [
          { id:"a", text:"„Wenn mein Herz klopft, ist alles verloren.“", correct:false },
          { id:"b", text:"„Ich darf das nicht spüren, sonst blamiere ich mich.“", correct:false },
          { id:"c", text:"„Mein Körper mobilisiert Energie – ich kann das nutzen.“", correct:true },
          { id:"d", text:"„Ich muss völlig ruhig sein, sonst bin ich unfähig.“", correct:false }
        ],
        hint: "Nicht wegdrücken – sinnvoll interpretieren.",
        solution: "Körpersymptome können als Aktivierung gedeutet werden (Energie/Sauerstoff/Schärfung), statt als Katastrophenzeichen."
      },
      {
        id: "q4",
        type: "text",
        source: "Blackout-Notfall",
        prompt: "Nenne zwei konkrete Schritte, die bei einem Blackout in der Prüfung helfen können.",
        check: (ans)=> containsKeywords(ans, ["blatt umdrehen","atmen","bauch","langsam","2","3 minuten","pause","haende auf den bauch"], 2),
        hint: "Denk an: Zeit gewinnen + Atmung runterfahren.",
        solution: "Beispiel: Prüfungsblatt kurz umdrehen und 2–3 Minuten langsam in den Bauch atmen (evtl. Hände auf den Bauch). Dann erst Aufgaben sichten und mit einer leichteren starten."
      },
      {
        id: "q5",
        type: "mc",
        source: "Kommunikation",
        prompt: "Welche Reaktion von Eltern/Lehrpersonen ist eher hilfreich?",
        options: [
          { id:"a", text:"„Du brauchst keine Angst zu haben“ (Angst wegreden).", correct:false },
          { id:"b", text:"„Streng dich endlich an, sonst…“ (Drohung).", correct:false },
          { id:"c", text:"„Ich sehe, dass du Angst hast. Was brauchst du, damit es besser wird?“", correct:true },
          { id:"d", text:"„Wenn du nicht perfekt bist, bringt das alles nichts.“", correct:false }
        ],
        hint: "Ernst nehmen + nach Bedürfnissen fragen.",
        solution: "Hilfreich ist: Gefühle ernst nehmen, Druck reduzieren, gemeinsam konkrete Unterstützungen planen."
      },
      {
        id: "q6",
        type: "text",
        source: "Erwartungen/Perfektionismus",
        prompt: "Warum kann Perfektionismus Prüfungsangst verstärken? (2–4 Sätze)",
        check: (ans)=> containsKeywords(ans, ["erwartung","fehler","katastrophe","supernoten","druck","selbstwert","versagen"], 3),
        hint: "Wenn nur „sehr gut“ zählt, wird jede Unsicherheit zur Gefahr.",
        solution: "Perfektionismus erhöht Erwartungen und die Bedeutung der Note. Fehler werden als Bedrohung erlebt („Versagen“), wodurch Stress steigt und der Zugriff auf Wissen eher blockiert. Das verstärkt Angst und kann zu Überlernen oder Vermeidung führen."
      },
      {
        id: "q7",
        type: "mc",
        source: "Lernverhalten",
        prompt: "Welche Lernstrategie ist eher nachhaltig gegen Angst (statt „Öl ins Stressfeuer“)?",
        options: [
          { id:"a", text:"60–90 Minuten ohne Pause durchpauken.", correct:false },
          { id:"b", text:"Kurze, planbare Lernblöcke mit Pausen und realistischen Zielen.", correct:true },
          { id:"c", text:"Alles auf die letzte Nacht schieben, um Druck zu spüren.", correct:false },
          { id:"d", text:"Nur noch Themen lernen, die schon leicht sind.", correct:false }
        ],
        hint: "Denk an Konzentrationsspanne und Pausenwirkung.",
        solution: "Regelmässige, kurze Lernblöcke mit Pausen stabilisieren Konzentration und Selbstwirksamkeit."
      },
      {
        id: "q8",
        type: "text",
        source: "Selbstwirksamkeit",
        prompt: "Was bedeutet „Kontrolle/Selbstwirksamkeit zurückgewinnen“ bei Prüfungsangst?",
        check: (ans)=> containsKeywords(ans, ["ich kann etwas tun","steuerung","werkzeug","strategien","kontrolle","handlungsfaehig"], 3),
        hint: "Von „es passiert mit mir“ zu „ich kann etwas beeinflussen“.",
        solution: "Es bedeutet, konkrete Einflussmöglichkeiten zu haben (Atem, Tempo, Vorgehen, Gedanken, Vorbereitung). Dadurch wird man handlungsfähig und die Angst verliert Macht."
      },
      {
        id: "q9",
        type: "mc",
        source: "Schulangst/Schulphobie",
        prompt: "Was ist bei Schulphobie/Schulangst zentral?",
        options: [
          { id:"a", text:"Die Betroffenen wollen einfach nicht.", correct:false },
          { id:"b", text:"Es ist oft eine starke Angstreaktion mit körperlichen Symptomen und Vermeidung.", correct:true },
          { id:"c", text:"Man soll sie zwingen, dann verschwindet es sofort.", correct:false },
          { id:"d", text:"Das passiert nur in der Grundschule.", correct:false }
        ],
        hint: "Achte auf: Körper + Vermeidung + Belastung.",
        solution: "Schulangst kann massiv sein, körperlich spürbar, und führt häufig zu Vermeidung. Unterstützung und passende Settings sind zentral."
      },
      {
        id: "q10",
        type: "text",
        source: "Akut vs. Training",
        prompt: "Unterscheide: Was hilft im Akutfall (Minuten) – und was hilft als Training (Wochen)? Nenne je 1–2 Beispiele.",
        check: (ans)=> containsKeywords(ans, ["akut","atmen","pause","training","lernstrategie","realistische ziele","exposition","kleine pruefungssituationen"], 4),
        hint: "Akut: Körper runterregeln. Training: Muster verändern, Übungssituationen.",
        solution: "Akut helfen z. B. langsames Bauchatmen, Blatt umdrehen, kurze Orientierungsübung. Training sind z. B. realistische Zielsetzung, gute Lernroutinen, kleine Prüfungssimulationen/Übungen, Arbeit an Erwartungen/Perfektionismus."
      },
      {
        id: "q11",
        type: "mc",
        source: "Prüfungsmoment",
        prompt: "Welche Vorgehensweise kann Nervosität am Anfang einer Prüfung reduzieren?",
        options: [
          { id:"a", text:"Extra schnell starten, um es „hinter sich zu bringen“.", correct:false },
          { id:"b", text:"Erst Aufgaben überfliegen, dann strukturiert beginnen (evtl. mit leichter Aufgabe).", correct:true },
          { id:"c", text:"Sofort mit der schwierigsten Aufgabe beginnen, um Mut zu beweisen.", correct:false },
          { id:"d", text:"Nicht planen – einfach drauflos schreiben.", correct:false }
        ],
        hint: "Tempo und Struktur sind Steuerungsmittel.",
        solution: "Überblick + Struktur senken Chaosgefühl und geben Kontrolle zurück."
      },
      {
        id: "q12",
        type: "text",
        source: "Druck & Umfeld",
        prompt: "Warum kann der Satz „Es geht um die Zukunft – das muss klappen!“ die Angst verstärken? (2–3 Sätze)",
        check: (ans)=> containsKeywords(ans, ["druck","zukunft","momentaufnahme","erwartung","katastrophisieren","last"], 3),
        hint: "Wenn alles „Weiche“ wird, wird Angst logisch.",
        solution: "Der Satz macht aus einer Prüfung eine Existenzfrage. Das verstärkt Katastrophisieren und erhöht Stress. Sinnvoller ist die Einordnung als Momentaufnahme und der Fokus auf beeinflussbare Schritte."
      },
      {
        id: "q13",
        type: "mc",
        source: "Kleine Interventionen",
        prompt: "Was ist der Sinn von „kleinen Prüfungssituationen“ (Übungs-Tests)?",
        options: [
          { id:"a", text:"Kinder sollen sich daran gewöhnen, dass sie scheitern.", correct:false },
          { id:"b", text:"Angst wird messbar – und man kann in kleinen Dosen Bewältigung lernen.", correct:true },
          { id:"c", text:"Man kann noch mehr Druck aufbauen.", correct:false },
          { id:"d", text:"Es geht nur um bessere Noten, nicht um Angst.", correct:false }
        ],
        hint: "Dosis + Erfahrung von Bewältigung.",
        solution: "Kleine Tests bauen Selbstwirksamkeit auf und unterbrechen den Angstkreislauf, weil Bewältigung erlebt wird."
      },
      {
        id: "q14",
        type: "text",
        source: "Systemblick",
        prompt: "Nenne einen Zusammenhang zwischen Schulsystem/Selektion und Stress, der in den Materialien sichtbar wird.",
        check: (ans)=> containsKeywords(ans, ["selektion","gymi","aufnahmepruefung","druck","rare plaetze","stress","durchlaessigkeit"], 3),
        hint: "Selektion + Bedeutung der Prüfung + gesellschaftliche Erwartungen.",
        solution: "Beispiel: Wenn Aufnahmeprüfungen als „Weiche für die Zukunft“ gerahmt werden und Plätze knapp sind, steigt Druck. Das verstärkt Stress/Angst und kann Ungleichheiten (Bildungsnähe) verschärfen."
      },
      {
        id: "q15",
        type: "mc",
        source: "Realistisches Denken",
        prompt: "Welche Selbstinstruktion ist am ehesten realistisch und hilfreich?",
        options: [
          { id:"a", text:"„Ich darf keine Angst haben.“", correct:false },
          { id:"b", text:"„Ich werde sicher scheitern.“", correct:false },
          { id:"c", text:"„Ich gebe mein Bestes und gehe Schritt für Schritt.“", correct:true },
          { id:"d", text:"„Nur Perfektion zählt.“", correct:false }
        ],
        hint: "Hilfreich = wahr + handlungsorientiert.",
        solution: "Realistische, handlungsorientierte Sätze stabilisieren und senken Stress."
      }
    ];

    // ===== Reflexion data (15) =====
    const reflexion = [
      {
        id: "r1",
        title: "Mein Prüfungsangst-Profil",
        prompt: "Beschreibe eine typische Situation: Wann beginnt der Stress? Wie steigt er? Was passiert im Körper? Was im Kopf?",
        tags: ["koerper","gedanken","verlauf","trigger"]
      },
      {
        id: "r2",
        title: "Meine Trigger-Landkarte",
        prompt: "Liste 5 konkrete Trigger (z. B. Zeitdruck, Vergleich, Erwartungsdruck, bestimmte Fächer, bestimmte Lehrperson). Ordne sie von 1 (mild) bis 5 (heftig).",
        tags: ["trigger","prioritaet"]
      },
      {
        id: "r3",
        title: "Mein innerer Kommentar",
        prompt: "Welche 3 Sätze sagt deine Angst am häufigsten? (Wortlaut!) Und: Was ist der „Subtext“ dahinter (z. B. Angst vor Blamage, Angst zu enttäuschen)?",
        tags: ["innererDialog","subtext"]
      },
      {
        id: "r4",
        title: "Verhalten unter Druck",
        prompt: "Was tust du typischerweise, wenn Angst da ist? (Vermeiden, Überlernen, Prokrastination, Kontrollieren, Rückzug…) Was ist der kurzfristige Gewinn – und der langfristige Preis?",
        tags: ["verhalten","vermeidung","kostenNutzen"]
      },
      {
        id: "r5",
        title: "Der Perfektionshebel",
        prompt: "Wo zeigt sich Perfektionismus? (Noten, Fehler, Tempo, Vergleich…) Was wäre eine realistische „gut genug“-Definition für dich?",
        tags: ["perfektionismus","realismus"]
      },
      {
        id: "r6",
        title: "Mein Notfall-Anker (30–90 s)",
        prompt: "Entwirf eine Mini-Routine für den Prüfungsmoment: 3 Schritte, die du im Notfall machst (z. B. Atmen, Blatt umdrehen, Scan, Start leicht).",
        tags: ["notfall","routine"]
      },
      {
        id: "r7",
        title: "Meine Lernroutine (machbar!)",
        prompt: "Beschreibe eine Lernroutine, die du wirklich durchhältst: Blocklänge, Pausen, Wiederholung, Abschlusszeitpunkt am Abend.",
        tags: ["lernstrategie","zeit","pause"]
      },
      {
        id: "r8",
        title: "Satz an mich selbst",
        prompt: "Formuliere 2 realistische Selbstinstruktionen für die Prüfung (keine Floskeln). Beispiel: „Schritt für Schritt. Erst Überblick, dann Start.“",
        tags: ["selbstinstruktion"]
      },
      {
        id: "r9",
        title: "Sicherheitsnetz",
        prompt: "Welche 2 Personen könnten dich unterstützen? Was genau wäre hilfreich (z. B. kurze Nachricht, Begleitung, Lernplanung, Entlastung)?",
        tags: ["umfeld","support"]
      },
      {
        id: "r10",
        title: "Umgang mit Fehlern",
       prompt: "Wie reagierst du auf Fehler? Schreibe eine neue Fehler-Regel: Was tust du, wenn du merkst, dass du dich verrannt hast?",
        tags: ["fehlerkultur","flexibilitaet"]
      },
      {
        id: "r11",
        title: "Vergleich & Druck",
        prompt: "Wann vergleichst du dich? Was löst das aus? Entwickle eine Alternative: Was misst du stattdessen (z. B. Prozess, Fortschritt, Strategie-Anwendung)?",
        tags: ["vergleich","prozess"]
      },
      {
        id: "r12",
        title: "Die Prüfung als Momentaufnahme",
        prompt: "Schreibe 3 Sätze, die die Bedeutung der Prüfung realistisch einordnen, ohne sie kleinzureden.",
        tags: ["reframe","bedeutung"]
      },
      {
        id: "r13",
        title: "Mini-Exposition",
        prompt: "Plane eine kleine „Prüfungssimulation“ (10–20 Minuten). Was ist die Aufgabe? Wie misst du Erfolg (nicht nur Note)?",
        tags: ["exposition","simulation"]
      },
      {
        id: "r14",
        title: "Schlaf & Körper",
        prompt: "Was passiert bei dir mit Schlaf/Essen/Bewegung vor Prüfungen? Nenne 2 kleine Stellschrauben, die realistisch sind.",
        tags: ["koerper","schlaf","grundlagen"]
      },
      {
        id: "r15",
        title: "Mein 7-Tage-Plan",
        prompt: "Wähle 3 Strategien aus diesem Lernraum und plane sie für die nächsten 7 Tage (konkret: wann, wie lange, wie überprüfst du Wirkung?).",
        tags: ["umsetzung","plan"]
      }
    ];

    // ===== Rendering Quiz & Reflexion =====
    function renderQuiz(){
      const wrap = byId("quizWrap");
      wrap.innerHTML = "";

      quiz.forEach((q, idx)=>{
        const done = !!state.quiz.done[q.id];
        const attempts = state.quiz.attempts[q.id] || 0;

        const card = document.createElement("div");
        card.className = "qCard";
        card.dataset.qid = q.id;

        const badge = done ? "Abgeschlossen" : ("Versuche: " + attempts + "/3");
        const badgeStyle = done ? "style='border-color: rgba(167,255,176,.45);'" : "";

        const top = document.createElement("div");
        top.className = "qTop";
        top.innerHTML = `
          <div class="qBadge" ${badgeStyle}>
            <strong>Frage ${idx+1}/15</strong> · ${escapeHtml(q.source)} · ${escapeHtml(badge)}
          </div>
          <div class="btnRow" style="margin-top:0;">
            ${done ? `<button class="btn good" disabled>✓ erledigt</button>` : `<button class="btn primary" data-action="check">Antwort prüfen</button>`}
          </div>
        `;

        const prompt = document.createElement("div");
        prompt.className = "qPrompt";
        prompt.innerHTML = `<strong>${escapeHtml(q.prompt)}</strong>`;

        const body = document.createElement("div");

        // Answer UI
        if(q.type === "mc"){
          const saved = state.quiz.answers[q.id]?.order;
          let opts = q.options.map(o=>({ ...o }));
          const order = saved || shuffleArray(opts.map(o=>o.id));
          opts = order.map(id=> q.options.find(o=>o.id===id));

          state.quiz.answers[q.id] = state.quiz.answers[q.id] || {};
          state.quiz.answers[q.id].order = order;

          const selected = state.quiz.answers[q.id]?.selected || "";

          body.innerHTML = `
            <div class="options">
              ${opts.map(o=>{
                const checked = (selected === o.id) ? "checked" : "";
                return `
                  <label class="opt">
                    <input type="radio" name="${q.id}" value="${o.id}" ${checked} ${done ? "disabled": ""}/>
                    <div>${escapeHtml(o.text)}</div>
                  </label>
                `;
              }).join("")}
            </div>
          `;
        } else {
          const val = (state.quiz.answers[q.id]?.text || "");
          body.innerHTML = `
            <textarea class="textAnswer" ${done ? "disabled": ""} placeholder="Antwort schreiben…">${escapeHtml(val)}</textarea>
          `;
        }

        const fb = document.createElement("div");
        fb.className = "feedback";
        fb.id = "fb_"+q.id;
        fb.textContent = done
          ? ("Musterlösung:\n" + q.solution)
          : "Noch nicht geprüft.";

        if(done){
          fb.classList.add("good");
        }

        const nav = document.createElement("div");
        nav.className = "btnRow";
        nav.style.marginTop = "12px";

        const prevDisabled = idx === 0 ? "disabled" : "";
        const nextDisabled = idx === quiz.length-1 ? "disabled" : "";
        nav.innerHTML = `
          <button class="btn" data-action="prev" ${prevDisabled}>← Vorherige</button>
          <button class="btn" data-action="next" ${nextDisabled}>Nächste →</button>
        `;

        card.appendChild(top);
        card.appendChild(prompt);
        card.appendChild(body);
        card.appendChild(fb);
        card.appendChild(nav);

        wrap.appendChild(card);

        const checkBtn = card.querySelector("[data-action='check']");
        if(checkBtn){
          checkBtn.addEventListener("click", ()=> onCheckQuiz(q.id));
        }

        if(q.type === "mc"){
          card.querySelectorAll("input[type=radio]").forEach(r=>{
            r.addEventListener("change", ()=>{
              state.quiz.answers[q.id] = state.quiz.answers[q.id] || {};
              state.quiz.answers[q.id].selected = r.value;
              saveState();
            });
          });
        } else {
          const ta = card.querySelector("textarea");
          ta.addEventListener("input", ()=>{
            state.quiz.answers[q.id] = state.quiz.answers[q.id] || {};
            state.quiz.answers[q.id].text = ta.value;
            saveState();
          });
        }

        card.querySelector("[data-action='prev']").addEventListener("click", ()=>{
          const prev = wrap.children[idx-1];
          if(prev) prev.scrollIntoView({behavior:"smooth", block:"start"});
        });
        card.querySelector("[data-action='next']").addEventListener("click", ()=>{
          const next = wrap.children[idx+1];
          if(next) next.scrollIntoView({behavior:"smooth", block:"start"});
        });
      });

      saveState();
    }

    function onCheckQuiz(qid){
      const q = quiz.find(x=>x.id===qid);
      if(!q) return;

      if(state.quiz.done[qid]){
        toast("Diese Frage ist schon abgeschlossen.");
        return;
      }

      const attempts = (state.quiz.attempts[qid] || 0);
      const fb = byId("fb_"+qid);

      let isCorrect = false;

      if(q.type === "mc"){
        const selected = state.quiz.answers[qid]?.selected || "";
        if(!selected){
          fb.className = "feedback warn";
          fb.textContent = "Bitte eine Option wählen.";
          return;
        }
        const opt = q.options.find(o=>o.id===selected);
        isCorrect = !!opt?.correct;
      } else {
        const ans = state.quiz.answers[qid]?.text || "";
        if(!normalizeText(ans)){
          fb.className = "feedback warn";
          fb.textContent = "Bitte eine Antwort schreiben.";
          return;
        }
        isCorrect = q.check(ans);
      }

      if(isCorrect){
        state.quiz.done[qid] = true;
        fb.className = "feedback good";
        fb.textContent = "Richtig.\n\nMusterlösung:\n" + q.solution;
        toast("Richtig – weiter so.");
        saveState();
        renderQuiz();
        updateAll();
        return;
      }

      const newAttempts = attempts + 1;
      state.quiz.attempts[qid] = newAttempts;

      if(newAttempts === 1){
        fb.className = "feedback bad";
        fb.textContent = "Falsch.\n\nVersuch 2: Lies die Frage nochmals genau und suche den Mechanismus (Ursache → Wirkung).";
      } else if(newAttempts === 2){
        fb.className = "feedback warn";
        fb.textContent = "Noch nicht.\n\nHinweis:\n" + q.hint;
      } else {
        state.quiz.done[qid] = true;
        fb.className = "feedback good";
        fb.textContent = "Musterlösung eingeblendet (nach 3 Versuchen):\n\n" + q.solution;
        toast("Musterlösung – weiter zur nächsten Frage.");
      }

      saveState();
      renderQuiz();
      updateAll();
    }

    function renderReflexion(){
      const wrap = byId("refWrap");
      wrap.innerHTML = "";

      reflexion.forEach((r, idx)=>{
        const done = !!state.reflexion.done[r.id];
        const text = state.reflexion.text[r.id] || "";
        const bot = state.reflexion.bot[r.id] || "";

        const card = document.createElement("div");
        card.className = "qCard";
        card.dataset.rid = r.id;

        card.innerHTML = `
          <div class="qTop">
            <div class="qBadge" style="${done ? "border-color: rgba(167,255,176,.45);" : ""}">
              <strong>Aufgabe ${idx+1}/15</strong> · ${escapeHtml(r.title)} · ${done ? "Abgeschlossen" : "Offen"}
            </div>
            <div class="btnRow" style="margin-top:0;">
              <button class="btn primary" data-action="bot">${done ? "Kommentar erneut" : "Kommentar erhalten"}</button>
              <button class="btn good" data-action="saveTool">Strategie speichern</button>
            </div>
          </div>
          <div class="qPrompt" style="margin-top:10px;">
            <strong>${escapeHtml(r.prompt)}</strong>
          </div>
          <textarea class="textAnswer" placeholder="Schreibe hier…">${escapeHtml(text)}</textarea>
          <div class="feedback ${bot ? "good" : ""}" id="bot_${r.id}">${bot ? escapeHtml(bot) : "Chatbot-Kommentar erscheint hier."}</div>
          <div class="mini" style="margin-top:10px;">
            Tipp: Du kannst aus dem Kommentar einzelne Sätze/Ideen direkt als Strategie speichern.
          </div>
        `;

        wrap.appendChild(card);

        const ta = card.querySelector("textarea");
        ta.addEventListener("input", ()=>{
          state.reflexion.text[r.id] = ta.value;
          saveState();
        });

        card.querySelector("[data-action='bot']").addEventListener("click", ()=>{
          const input = ta.value || "";
          const reply = botComment(r, input);
          state.reflexion.bot[r.id] = reply;
          state.reflexion.done[r.id] = true;
          saveState();
          renderReflexion();
          updateAll();
          toast("Kommentar erstellt.");
        });

        card.querySelector("[data-action='saveTool']").addEventListener("click", ()=>{
          const input = ta.value || "";
          const reply = state.reflexion.bot[r.id] || "";
          const strat = extractStrategy(r, input, reply);
          state.reflexion.strategies.push(strat);
          saveState();
          renderToolboxLive();
          toast("Strategie gespeichert.");
        });
      });
    }

    // ===== Bot (empathisch, nicht anbiedernd) =====
    function botComment(task, userText){
      const t = normalizeText(userText);
      const len = t.length;

      const signals = {
        intense: ["panik","nicht atmen","kann nicht","stirbt","100 kilo","uebel","zitter","herzrasen","schwindel","blackout","nichts geht","kann nicht hingehen","schulphobie","weinen"],
        avoid: ["vermeide","druecke mich","gehe nicht","schiebe","prokrastin","krankschreiben","nicht hingehen"],
        perfection: ["perfekt","nur 6","nur sehr gut","keine fehler","muss","darf nicht","blamieren","enttaeuschen"],
        compare: ["andere","vergleich","besser","schlechter","alle koennen","alle sind weiter"],
        body: ["bauch","kopf","haende","schweiss","herz","atem","schlaf","mued","anspann"],
        time: ["zu wenig zeit","zeitdruck","schnell","zu spaet","wartezeit"],
      };

      function hasAny(list){
        return list.some(w => t.includes(normalizeText(w)));
      }

      const riskHigh = hasAny(signals.intense) || (hasAny(signals.avoid) && hasAny(signals.body));
      const hasAvoid = hasAny(signals.avoid);
      const hasPerf = hasAny(signals.perfection);
      const hasComp = hasAny(signals.compare);
      const hasBody = hasAny(signals.body);
      const hasTime = hasAny(signals.time);

      let lines = [];

      if(len < 15){
        lines.push("Ich kann daraus noch wenig lesen – aber ich nehme wahr: du willst das ernsthaft anschauen.");
        lines.push("Schreib bitte konkret: Was passiert zuerst (Trigger), dann im Körper, dann im Kopf, dann im Verhalten?");
        return lines.join("\n");
      }

      lines.push("Was bei dir sichtbar wird:");
      if(hasBody) lines.push("• Dein Körper meldet Alarm (Symptome/Anspannung) – das ist Stressphysiologie, nicht „Unfähigkeit“.");
      if(hasPerf) lines.push("• Da ist ein hoher Anspruch/Perfektionismus: Fehler wirken wie Gefahr, nicht wie Information.");
      if(hasAvoid) lines.push("• Vermeidung/Schieben wirkt kurzfristig entlastend – langfristig hält es die Angst am Leben.");
      if(hasComp) lines.push("• Vergleich verstärkt Druck: du misst dich an Bildern, nicht an deinem Prozess.");
      if(hasTime) lines.push("• Zeit/Tempo scheint ein zentraler Trigger zu sein – das ist gut beeinflussbar (Start-Routine, Tempo-Regel).");
      if(!hasBody && !hasPerf && !hasAvoid && !hasComp && !hasTime){
        lines.push("• Du beschreibst mehrere Ebenen (Gedanken/Gefühle/Handeln). Genau dort entstehen Stellschrauben.");
      }

      lines.push("");
      lines.push("Ein sinnvoller nächster Schritt:");
      if(hasAvoid){
        lines.push("• Nicht „alles“ ändern. Eine kleine, dosierte Konfrontation: 10–20 Minuten Prüfungssimulation (Timer) – danach bewusst stoppen.");
      } else {
        lines.push("• Baue Kontrolle zurück: Mini-Routine für den ersten Prüfungsminute (Atmung → Überblick → leichter Start).");
      }

      lines.push("");
      lines.push("Konkrete Werkzeuge (wähle 1–2, nicht alle):");
      const tools = [];
      tools.push("1) 4/6-Atmung: 4s ein, 6s aus (6 Runden).");
      tools.push("2) Start-Regel: zuerst Aufgaben scannen, dann mit einer machbaren beginnen.");
      tools.push("3) Realistischer Satz: „Schritt für Schritt. Ich steuere Tempo und Fokus.“");
      if(hasPerf) tools.push("4) „Gut-genug“-Kriterium: definiere vorab, was ein solides Ergebnis ist (nicht Ideal).");
      if(hasComp) tools.push("5) Vergleichs-Stopp: statt „Andere“ → „Welche Strategie setze ich jetzt um?“");
      if(hasAvoid) tools.push("6) Belohnung nach Umsetzung (nicht nach Note): z. B. Musik/Spaziergang nach 20 Min Simulation.");
      tools.push("7) Fehler-Regel: wenn verrannt → 30s Pause, markieren, später zurückkommen.");
      lines = lines.concat(tools.map(x=>"• " + x));

      if(riskHigh){
        lines.push("");
        lines.push("Wenn das bei dir Richtung Schulvermeidung/Panik geht: Das ist ernst – und du musst das nicht allein tragen.");
        lines.push("Ein guter Schritt wäre: eine Vertrauensperson einweihen und professionelle Hilfe prüfen (Schulsozialarbeit, Ärzt*in, Psycholog*in).");
      }

      lines.push("");
      lines.push("Mini-Auftrag bis zur nächsten Aufgabe:");
      lines.push("• Formuliere 1 Satz, der dich entkatastrophisiert – und 1 Handlung, die du in der Prüfung wirklich tun wirst.");

      return lines.join("\n");
    }

    function extractStrategy(task, userText, botText){
      const base = normalizeText(userText);
      const level = inferLevel(base);
      const when = inferWhen(task, base);
      const title = makeStrategyTitle(task, base);
      const how = makeHow(task, base);
      const why = makeWhy(task, base, botText);

      return {
        id: "s_" + task.id + "_" + Date.now(),
        title,
        level,
        when,
        how,
        why
      };
    }

    function inferLevel(t){
      if(t.includes("bauch") || t.includes("atem") || t.includes("blackout") || t.includes("panik")) return "Prüfungsmoment";
      if(t.includes("7 tage") || t.includes("woche") || t.includes("routine") || t.includes("lern")) return "Vorbereitung";
      if(t.includes("nach") || t.includes("fehler") || t.includes("auswertung")) return "Nachbereitung";
      return "Vorbereitung";
    }

    function inferWhen(task, t){
      const map = {
        r6: "In der Prüfung – sobald Alarm hochgeht",
        r7: "In den Tagen vor der Prüfung",
        r13:"In der Woche vor der Prüfung (Simulation)",
        r15:"Nächste 7 Tage (Umsetzung)",
        r4: "Wenn du merkst: du weichst aus / schiebst",
        r5: "Wenn du Perfektionsdruck spürst",
        r14:"Abends / morgens vor Prüfungen",
        r10:"Wenn ein Fehler passiert",
      };
      return map[task.id] || "Wenn du merkst: Stress steigt";
    }

    function makeStrategyTitle(task, t){
      const titles = {
        r6: "Notfall-Anker: Atmen → Überblick → Start",
        r7: "Lernroutine: kurze Blöcke + Pausen",
        r8: "Selbstinstruktion: realistisch & handlungsorientiert",
        r10:"Fehler-Regel: kurz stoppen, dann weiter",
        r12:"Reframe: Prüfung ist Momentaufnahme",
        r13:"Mini-Simulation: dosiert üben",
        r4: "Anti-Vermeidung: klein starten",
        r5: "Gut-genug-Kriterium statt Perfektion",
        r14:"Körper-Basics: Schlaf/Bewegung als Stresspuffer",
        r15:"7-Tage-Umsetzung: 3 Strategien planen"
      };
      return titles[task.id] || ("Strategie aus: " + task.title);
    }

    function makeHow(task, t){
      if(t.includes("4") && t.includes("6") && t.includes("atem")) return "4 Sekunden ein, 6 Sekunden aus – 6 Runden.";
      if(t.includes("blatt") && t.includes("umdrehen")) return "Blatt kurz umdrehen, 2–3 Minuten langsam atmen, dann Aufgaben scannen.";
      if(t.includes("pause")) return "Lernblöcke mit festen Pausen (z. B. 45/10) – Pause wirklich weg vom Stoff.";
      if(t.includes("timer")) return "Timer stellen (10–20 Min) und eine Mini-Prüfungssituation durchführen.";
      return "Konkrete Schritte definieren (max. 3), dann 1 Woche testen und Wirkung notieren.";
    }

    function makeWhy(task, t, bot){
      if(normalizeText(bot).includes("kontrolle")) return "Gibt Kontrolle zurück und senkt Alarm im System.";
      if(t.includes("vermeide")) return "Unterbricht den Vermeidungs-Kreislauf und baut Selbstwirksamkeit auf.";
      if(t.includes("perfekt") || t.includes("fehler")) return "Reduziert Katastrophisieren und macht Handeln möglich.";
      return "Stabilisiert Fokus und macht die Situation bewältigbar.";
    }

    // ===== Toolbox live =====
    function renderToolboxLive(){
      const box = byId("toolboxLive");
      const arr = state.reflexion.strategies || [];
      if(!arr.length){
        box.innerHTML = "<h3>Gespeicherte Strategien</h3><div class='mini'>Noch keine gespeichert.</div>";
        return;
      }

      const items = arr.slice(-10).reverse().map(s=>{
        return `
          <div style="padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); margin-top:10px;">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <strong>${escapeHtml(s.title)}</strong>
              <span class="mini">${escapeHtml(s.level)}</span>
            </div>
            <div class="mini" style="margin-top:6px;"><strong>Wann:</strong> ${escapeHtml(s.when)}</div>
            <div class="mini" style="margin-top:4px;"><strong>Wie:</strong> ${escapeHtml(s.how)}</div>
            <div class="mini" style="margin-top:4px;"><strong>Wozu:</strong> ${escapeHtml(s.why)}</div>
          </div>
        `;
      }).join("");

      box.innerHTML = `
        <h3>Gespeicherte Strategien</h3>
        <div class="mini">Zuletzt gespeichert (max. 10 angezeigt):</div>
        ${items}
      `;
    }

    // ===== Plan =====
    function buildPlan(){
      const arr = state.reflexion.strategies || [];
      const prep = arr.filter(s=>s.level==="Vorbereitung");
      const moment = arr.filter(s=>s.level==="Prüfungsmoment");
      const after = arr.filter(s=>s.level==="Nachbereitung");

      function listStr(list){
        if(!list.length) return "<div class='mini'>Noch keine Strategien in dieser Kategorie.</div>";
        return "<ul>" + list.slice(-6).reverse().map(s=>{
          return `<li><strong>${escapeHtml(s.title)}:</strong> ${escapeHtml(s.how)} <span class="mini">(${escapeHtml(s.when)})</span></li>`;
        }).join("") + "</ul>";
      }

      const mood = state.mood ?? 0;

      const box = byId("planBox");
      box.innerHTML = `
        <h3>Dein Plan (automatisch aus deinen gespeicherten Strategien)</h3>
        <div class="mini">Aktueller Stress-Check: <strong>${mood}/10</strong>. Bei hohen Werten: zuerst „Prüfungsmoment“-Anker priorisieren.</div>

        <div class="hr"></div>

        <h3>1) Vorbereitung (Tage/Wochen)</h3>
        ${listStr(prep)}

        <div class="hr"></div>

        <h3>2) Prüfungsmoment (Minuten)</h3>
        ${listStr(moment)}

        <div class="hr"></div>

        <h3>3) Nachbereitung (Lernen aus der Erfahrung)</h3>
        ${listStr(after)}

        <div class="hr"></div>

        <div class="mini"><strong>Mini-Regel:</strong> Weniger ist mehr. Wähle 1–2 Kernstrategien pro Ebene.</div>
      `;
    }

    byId("buildPlanBtn").addEventListener("click", ()=>{
      buildPlan();
      toast("Plan aktualisiert.");
    });

    byId("copyPlanBtn").addEventListener("click", async ()=>{
      const txt = stripHtml(buildExportText());
      try{
        await navigator.clipboard.writeText(txt);
        toast("Plan kopiert.");
      }catch(e){
        toast("Kopieren nicht möglich – nutze Export.");
      }
    });

    byId("clearPlanNotesBtn").addEventListener("click", ()=>{
      const ok = confirm("Plan-Notizen löschen?");
      if(ok){
        state.planNotes = "";
        byId("planNotes").value = "";
        saveState();
        toast("Notizen gelöscht.");
      }
    });

    byId("savePlanNotesBtn").addEventListener("click", ()=>{
      state.planNotes = byId("planNotes").value || "";
      saveState();
      toast("Notizen gespeichert.");
    });

    // ===== Export =====
    function buildExportText(){
      const arr = state.reflexion.strategies || [];
      const notes = state.planNotes || "";
      const quizDone = Object.values(state.quiz.done || {}).filter(Boolean).length;
      const refDone = Object.values(state.reflexion.done || {}).filter(Boolean).length;

      const lines = [];
      lines.push("MEIN PLAN GEGEN PRÜFUNGSANGST");
      lines.push("=====================================");
      lines.push("Fortschritt: Quiz " + quizDone + "/15 · Selbsterfahrung " + refDone + "/15");
      lines.push("Stress-Check: " + (state.mood ?? 0) + "/10");
      lines.push("");

      lines.push("GESPEICHERTE STRATEGIEN");
      lines.push("-------------------------------------");
      if(!arr.length){
        lines.push("(Noch keine Strategien gespeichert.)");
      } else {
        arr.forEach((s, i)=>{
          lines.push((i+1)+") " + s.title);
          lines.push("   Ebene: " + s.level);
          lines.push("   Wann: " + s.when);
          lines.push("   Wie: " + s.how);
          lines.push("   Wozu: " + s.why);
          lines.push("");
        });
      }

      lines.push("");
      lines.push("MEINE KONKRETEN VEREINBARUNGEN");
      lines.push("-------------------------------------");
      lines.push(notes ? notes : "(Keine Notizen.)");
      lines.push("");

      lines.push("NOTFALL-ANKER (Kurzfassung)");
      lines.push("-------------------------------------");
      lines.push("• 4s ein / 6s aus – 6 Runden.");
      lines.push("• Überblick → leichte Aufgabe → Tempo steuern.");
      lines.push("");

      return lines.join("\n");
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ===== Progress =====
    function updateProgress(){
      const quizDone = Object.values(state.quiz.done || {}).filter(Boolean).length;
      const refDone = Object.values(state.reflexion.done || {}).filter(Boolean).length;
      const tools = (state.reflexion.strategies || []).length;

      byId("kpiQuiz").textContent = quizDone + "/15";
      byId("kpiRef").textContent = refDone + "/15";
      byId("kpiTools").textContent = tools;

      const total = 30;
      const done = quizDone + refDone;
      const percent = Math.round((done / total) * 100);

      byId("progressFill").style.width = percent + "%";
      byId("progressText").textContent = "Fortschritt: " + percent + "%";
      byId("progressDetail").textContent = "Quiz: " + quizDone + "/15 · Selbsterfahrung: " + refDone + "/15 · Strategien gespeichert: " + tools;
    }

    function updateAll(){
      updateProgress();
      renderToolboxLive();
      const pn = byId("planNotes");
      if(pn && pn.value !== (state.planNotes || "")) pn.value = (state.planNotes || "");
    }

    // ===== Misc =====
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }
    function stripHtml(s){
      return String(s).replace(/<[^>]*>/g,"");
    }

    // ===== Init =====
    function init(){
      renderVideos();
      renderDocs();
      renderQuiz();
      renderReflexion();
      renderToolboxLive();
      buildPlan();

      setTab(state.tab || "start");

      byId("planNotes").value = state.planNotes || "";

      updateAll();
    }
    init();
  </script>
</body>
</html>
